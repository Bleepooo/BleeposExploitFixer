package dev.bleepo.bleeposexploitfixer.patches;

import dev.bleepo.bleeposexploitfixer.Main;
import dev.bleepo.bleeposexploitfixer.utils.TPS;
import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerMoveEvent;

public class ElytraLag implements Listener {
    private final Main plugin;

    public ElytraLag(Main plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    public void onFly(PlayerMoveEvent e) {
        if(plugin.getConfig().getBoolean("elytra.enabled")) {
            Player player = e.getPlayer();
            if(!player.isGliding())
                return;

            double speed = speeed(e);
            if(speed > plugin.getConfig().getInt("elytra.speed")) {
                e.setTo(e.getFrom());
                player.setGliding(false);
                if(plugin.getConfig().getBoolean("elytra.kick")) {
                    player.kickPlayer(ChatColor.translateAlternateColorCodes('&', plugin.getConfig().getString("elytra.message")));
                }
                player.sendMessage(ChatColor.translateAlternateColorCodes('&', plugin.getConfig().getString("elytra.message")));
            }

            if(plugin.getConfig().getBoolean("elytra.disabledattps")) {
                double tps = TPS.getTPS();
                if(tps < plugin.getConfig().getInt("elytra.tps")) {
                    e.setCancelled(true);
                    player.setGliding(false);
                    player.sendMessage(ChatColor.translateAlternateColorCodes('&', plugin.getConfig().getString("elytra.lowtpsmessage")));
                }
            }
        }
    }

    private double speeed(PlayerMoveEvent e) {
        Location from = e.getFrom();
        Location to = e.getTo();
        double X = to.getX();
        double Z = to.getZ();
        return Math.hypot(X, Z);
    }
}
